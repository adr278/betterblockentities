# Automatic Gradle-based release workflow
# Generates tags, changelogs, and uploads release assets automatically

name: auto-release

on:
  push:
    branches:
      - '*'  # Trigger whenever code is pushed to any branch

permissions:
  contents: write  # Needed to push tags and create releases

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed to access all tags for changelog comparison

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: true

      - name: Make Gradle wrapper executable
        run: chmod +x ./gradlew

      # üß© Read project version from Gradle
      - name: Extract Gradle version
        id: version
        run: |
          version=$(./gradlew properties | grep "^version:" | awk '{print $2}')
          echo "version=${version}" >> $GITHUB_OUTPUT
          echo "Detected version: ${version}"

      # üè∑Ô∏è Create and push a new Git tag if it doesn't exist
      - name: Create tag if missing
        run: |
          tag="v${{ steps.version.outputs.version }}"
          if git rev-parse "$tag" >/dev/null 2>&1; then
            echo "Tag $tag already exists. Skipping tag creation."
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag -a "$tag" -m "Release $tag"
            git push origin "$tag"
          fi

      # üßæ CATEGORY-BASED TABLE-FORMATTED CHANGELOG
      - name: Generate changelog
        id: changelog
        run: |
          tag="v${{ steps.version.outputs.version }}"
          repo="${GITHUB_REPOSITORY}"

          echo "# üßæ Changelog for $tag" > changelog.md
          echo "" >> changelog.md

          git fetch --tags
          previous_tag=$(git describe --tags --abbrev=0 "$tag"^ 2>/dev/null || echo "")

          if [ -n "$previous_tag" ]; then
            range="$previous_tag..$tag"
          else
            range="$tag"
          fi

          declare -A categories
          categories=(
            ["‚ú® Features"]="feat|feature|add|added|implement|implemented|implementing|new"
            ["üêõ Fixes"]="fix|fixes|fixed|bug|bugfix|hotfix|patch|resolve"
            ["üßπ Refactors"]="refactor|cleanup|rework|rewrite"
            ["üìö Documentation"]="docs|doc|documentation|readme"
            ["‚¨ÜÔ∏è Dependencies"]="deps|dependency|bump|upgrade|update"
            ["üí• Breaking Changes"]="break|breaking|!"
            ["üß© Other Changes"]="."
          )

          # Function to linkify commit hashes
          linkify_hash() {
            hash="$1"
            short=$(echo "$hash" | cut -c1-7)
            echo "[\`$short\`](https://github.com/$repo/commit/$hash)"
          }

          # Collect raw commits
          git log $range --pretty=format:"%h%x09%s" > commits.txt

          # Categorize
          for category in "${!categories[@]}"; do
            regex="${categories[$category]}"
            matches=$(grep -Ei $regex commits.txt || true)

            if [ -n "$matches" ]; then
              echo "## $category" >> changelog.md
              echo "" >> changelog.md
              echo "| Description | Commit |" >> changelog.md
              echo "|------------|--------|" >> changelog.md

              while IFS=$'\t' read -r hash msg; do
                if echo "$msg" | grep -Ei "$regex" >/dev/null; then
                  desc=$(echo "$msg" | sed -E "s/^($regex)(\(.*\))?:[[:space:]]*//I")
                  link=$(linkify_hash "$hash")
                  echo "| $desc | $link |" >> changelog.md
                fi
              done <<< "$matches"

              echo "" >> changelog.md
            fi
          done

          echo "Generated changelog:"
          cat changelog.md

      # ‚öôÔ∏è Build with Gradle
      - name: Build project
        run: ./gradlew build -Pbuild.release=true

      # üöÄ Create or update GitHub Release and upload jars
      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          body_path: changelog.md
          files: build/libs/*.jar
          token: ${{ secrets.GITHUB_TOKEN }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
